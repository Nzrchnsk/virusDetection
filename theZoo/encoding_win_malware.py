import os

from utils.zip_helper import ZipHelper
from utils.malware_repository import MalwareRepository
import pathlib
import logging
from utils.logger_factory import LoggerFactory, get_logger


def main():
    malware_repository = MalwareRepository(pathlib.Path('conf/maldb.db'))
    zip_helper = ZipHelper(output_dir=pathlib.Path('encoding_mal_binaries'), password=b"infected")
    logger_factory = LoggerFactory()

    logger = get_logger('encoding_win_malware')

    win_malware = malware_repository.get_win_mal()

    for mal in win_malware:
        try:
            mal_dir = os.listdir(path=pathlib.Path(mal[1]))
            for zip_file in mal_dir:
                if zip_file.endswith('.zip'):
                    file_path = pathlib.Path(mal[1]) / zip_file
                    zip_helper.extract_all(zip_path=file_path)
                    logger.info('Extracted: ' + mal[1])
        except Exception as e:
            logger.error('Error from extract malware: ' + mal[1])


if __name__ == "__main__":
    main()
